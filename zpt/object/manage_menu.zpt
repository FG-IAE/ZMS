<!DOCTYPE html>
<html lang="en">
<tal:block tal:content="structure python:here.zmi_html_head(here,request)">zmi_html_head</tal:block>

<body tal:attributes="class python:' '.join(['zmi',request['lang'],'manage-menu',here.meta_id])">

<div id="zmi-header">
	<div class="navbar" style="position: static;">
				<a class="navbar-brand zmi-helper-clickable" target="_blank" tal:attributes="href python:'%s/manage'%here.breadcrumbs_obj_path()[0].getHome().id">
					<tal:block tal:content="structure python:here.zmi_icon(name='icon-cogs')"></tal:block>
					<span class="zmi-home-id" tal:content="python:here.breadcrumbs_obj_path()[0].getHome().id">Home-Id</span>
				</a>
				<div class="pull-right" style="cursor:pointer;padding:0.5em;">
					<i class="icon-angle-left" title="Move To Left" onclick="frmresize(-30)" style="color:#aaa;">&nbsp;</i>
					<i class="icon-angle-right" title="Move To Right" onclick="frmresize(30)" style="color:#aaa">&nbsp;</i>
				</div>
	</div><!-- .navbar -->
</div><!-- #zmi-header -->

<div class="zmi-sitemap" tal:define="global childNode python:here.breadcrumbs_obj_path()[0]"
	><tal:block tal:content="structure python:'<ol data-home-id=\042%s\042 data-id=\042%s\042 class=\042zmi-page\042>'%(childNode.getHome().id,childNode.id)"></tal:block
	><div tal:attributes="class python:['inactive','active'][childNode.isActive(request)]"
		><tal:block tal:content="structure python:here.zmi_icon(name='icon-caret-right toggle',extra='title=\042+\042 onclick=\042zmiToggleClick(this)\042')"
			></tal:block><a 
				tal:attributes="href python:'%s/manage_main?lang=%s'%(childNode.absolute_url(),request['lang'])" 
				onclick="return zmiFollowHref(this)">
			<tal:block tal:content="structure python:childNode.display_icon(request)">the icon</tal:block>
			<span tal:content="python:childNode.getTitlealt(request)">the titlealt</span>
		</a>
		<span class="dropdown" tal:condition="python:len(here.getLangIds())>1" tal:attributes="title python:here.getZMILangStr('TAB_LANGUAGES')">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown">
				<i title="Language" tal:condition="python:len(here.getLangIds())>1" 
					tal:attributes="title python:here.getLanguageLabel(request['lang'])" 
					style="color:#999;text-decoration:none;cursor:pointer" class="icon-flag"></i>
			</a>
			<ul class="dropdown-menu" tal:define="global coverage python:here.getDCCoverage(request); languages python:[]">
				<tal:block tal:condition="python:coverage.startswith('global.')">
					<tal:block tal:define="dummy0 python:languages.extend(here.getDescendantLanguages(coverage[len('global.'):],request))"></tal:block>
				</tal:block>
				<tal:block tal:condition="python:not coverage.startswith('global.')">
					<tal:block tal:define="dummy0 python:languages.append(coverage[len('local.'):])"></tal:block>
				</tal:block>
				<li tal:repeat="language languages">
					<a tal:attributes="href python:here.url_append_params(request['URL'],{'lang':language})">
						<tal:block tal:content="structure python:here.zmi_icon(name=['icon-check-empty','icon-check'][int(language==request['lang'])])"></tal:block>
						<tal:block tal:content="python:here.getLanguageLabel(language)">the language</tal:block>
						<tal:block tal:condition="python:language==here.getPrimaryLanguage()">[*]</tal:block>
					</a>
				</li>
			</ul>
		</span><!-- .dropdown -->
	</div>
	<tal:block tal:content="structure python:'</ol>'"></tal:block>
	<div>
		<span class="zmi-helper-clickable" onclick="zmiRefresh()"><i class="icon-refresh"></i> <tal:block tal:content="python:here.getZMILangStr('BTN_UPDATE')">Update</tal:block></span>
	</div>
</div>

<tal:block tal:content="structure python:here.zmi_html_foot(here,request)">zmi_html_foot</tal:block>
<tal:block tal:content="structure python:'<script>'"></tal:block>

function zmiToggleClick(toggle, callback) {
	$ZMI.writeDebug('zmiToggleClick: '+($(toggle).length)+';callback='+(typeof callback));
	var $container = $(toggle).parents("ol:first");
	$container.children(".zmi-page").remove();
	if ($(toggle).hasClass(zmi_icon_clazz("icon-caret-right"))) {
		$(toggle).removeClass(zmi_icon_clazz("icon-caret-right")).addClass(zmi_icon_clazz("icon-caret-down")).attr({title:'-'});
		var href = '';
		var homeId = null;
		$(toggle).parents(".zmi-page").each(function(){
				var dataId = $(this).attr("data-id");
				var dataHomeId = $(this).attr("data-home-id");
				if (homeId == null) {
					homeId = dataHomeId;
				}
				if (homeId != dataHomeId) {
					href = '/'+dataHomeId+'/'+homeId+href;
					homeId = dataHomeId;
				}
				else {
					href = '/'+dataId+href;
				}
			});
		if (homeId != null && !href.indexOf('/'+homeId)==0) {
			href = '/'+homeId+href;
		}
		// Set wait-cursor.
		$container.append( '<div id="loading" class="zmi-page"><i class="icon-spinner icon-spin"></i>&nbsp;&nbsp;'+getZMILangStr('MSG_LOADING')+'<'+'/div>');
		// JQuery.AJAX.get
		$ZMI.writeDebug('zmiToggleClick:'+href+'/manage_ajaxGetChildNodes?lang='+getZMILang());
		$.get(href+'/manage_ajaxGetChildNodes',{lang:getZMILang(),meta_types:'0,ZMSTrashcan',get_permissions:'True',get_restricted:'True'},function(data){
				// Reset wait-cursor.
				$("#loading").remove();
				// Get and iterate pages.
				var pages = $("pages",data).children("page");
				if ( pages.length == 0) {
					$(toggle).removeClass(zmi_icon_clazz("icon-caret-down")).attr({title:''});
				}
				else {
					for (var i = 0; i < pages.length; i++) {
						var page = pages[i];
						var page_home_id = $(page).attr("home_id");
						var page_id = $(page).attr("id").substr(page_home_id.length+1);
						var page_absolute_url = $(page).attr("absolute_url");
						var page_meta_type = $(page).attr("meta_id");
						var page_titlealt = $(page).attr("titlealt");
						var page_display_icon = $(page).attr("display_icon");
						var html = '';
						html += '<'+'ol data-id="'+page_id+'" data-home-id="'+page_home_id+'" class="zmi-page '+page_meta_type+'">';
						html += '<'+'div class="';
						/*
						if ($(page).attr("permissions")) {
							html += 'restricted ';
						}
						*/
						if ($(page).attr("active")== "0") {
							html += 'inactive ';
						} else {
							html += 'active ';
						}
						html += '">';
						html += zmi_icon("icon-caret-right toggle",'title="+" onclick="zmiToggleClick(this)"')+' ';
						html += '<'+'a href="'+page_absolute_url+'/manage_main?lang='+getZMILang()+'" onclick="return zmiFollowHref(this)">';
						html += page_display_icon+' ';
						html += page_titlealt;
						html += '<'+'/a> ';
						html += '<'+'/div>';
						html += '<'+'/ol>';
						$container.append(html);
					}
				}
				if (typeof callback == 'function') {
					$ZMI.writeDebug('zmiToggleClick: callback()');
					callback();
				}
			});
	}
	else if ($(toggle).hasClass(zmi_icon_clazz("icon-caret-down"))) {
		$(toggle).removeClass(zmi_icon_clazz("icon-caret-down")).addClass(zmi_icon_clazz("icon-caret-right")).attr({title:'+'});
		if (typeof callback == 'function') {
			$ZMI.writeDebug('zmiToggleClick: callback()');
			callback();
		}
	}
}
function zmiFollowHref(anchor) {
	self.window.parent.manage_main.location.href=$(anchor).attr("href");
	return false;
}
function zmiRefresh() {
	$("ol:not(:first)").remove();
	var $ol = $("ol:first");
	var id = $ol.attr("data-id");
	var homeId = $ol.attr("data-home-id");
	var href = self.window.parent.manage_main.location.href;
	if (href.indexOf('?')>0) {
		href = href.substr(0,href.indexOf('?'));
	}
	href = href.substr(0,href.lastIndexOf('/'));
	href = href.substr(href.indexOf(homeId)+homeId.length+1);
	var ids = href.split('/');
	var fn = function() {
			if (ids.length > 0) {
				var id = ids[0];
				ids = ids.slice(1,ids.length);
				$ZMI.writeDebug("zmiRefesh.fn: id="+id);
				if ($('*[data-id="'+id+'"][data-home-id="'+homeId+'"]').length==0) {
					homeId = id;
					id = ids[0];
					ids = ids.slice(1,ids.length);
				}
				$ZMI.writeDebug("zmiRefesh.fn: ##="+$('*[data-id="'+id+'"][data-home-id="'+homeId+'"]').length);
				zmiToggleClick($('*[data-id="'+id+'"][data-home-id="'+homeId+'"] .toggle'),arguments.callee);
			}
		};
	zmiToggleClick($('.toggle').removeClass(zmi_icon_clazz("icon-caret-down")).addClass(zmi_icon_clazz("icon-caret-right")),fn);
}
function frmresize(r) {
	var frmwidth = parseInt(parent.document.getElementsByTagName('frameset')[0].cols);
	frmwidth = frmwidth + r
	var colval = frmwidth + ",*";
	parent.document.getElementsByTagName('frameset')[0].cols=colval;
	$.cookies.set('zmi_menu_frmsize',colval, { expires: 365 })
}
$ZMI.registerReady(function(){
	zmiRefresh();
	if ( $.cookies.get('zmi_menu_frmsize') ) {
		parent.document.getElementsByTagName('frameset')[0].cols = $.cookies.get('zmi_menu_frmsize');
	};
});

<tal:block tal:content="structure python:'</script>'"></tal:block>
</body>
</html>